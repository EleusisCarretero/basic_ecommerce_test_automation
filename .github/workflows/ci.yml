name: CI Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: |
          rm -rf ~/.cache/pip
          pip install --upgrade pip
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi
          pip show test_utils
      
      - name: Desactivar Selenium Manager
        run: echo "SE_MANAGER=0" >> $GITHUB_ENV
      
      - name: Instalar Chromedriver
        run: |
          echo "‚è≥ Verificando si Chromedriver ya est√° instalado..."
          if command -v chromedriver &> /dev/null; then
            echo "‚úÖ Chromedriver ya est√° instalado: $(chromedriver --version)"
          else
            echo "üì• Descargando la versi√≥n de Chromedriver compatible con Chrome $CHROME_VERSION..."
            
            CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION")
            
            if [ -z "$CHROMEDRIVER_VERSION" ]; then
              echo "‚ö†Ô∏è No se pudo obtener la versi√≥n de Chromedriver. Usando la √∫ltima versi√≥n conocida."
              CHROMEDRIVER_VERSION="133.0.6943.98"  # √öltima versi√≥n conocida de Chromedriver
            fi
      
            echo "üì• Descargando Chromedriver versi√≥n: $CHROMEDRIVER_VERSION..."
            wget -q "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip" || {
              echo "‚ùå Error al descargar Chromedriver. Reintentando con la √∫ltima versi√≥n estable."
              wget -q "https://chromedriver.storage.googleapis.com/133.0.6943.98/chromedriver_linux64.zip"
            }
      
            unzip chromedriver_linux64.zip
            sudo mv chromedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/chromedriver
      
            echo "‚úÖ Chromedriver instalado en: $(which chromedriver)"
          fi
      
      

      - name: Verificar instalaci√≥n de Chromedriver
        run: chromedriver --version

      - uses: actions/checkout@v4
        if: success() || failure()
      - run: |
          pytest tests -v -s -m Smoke
